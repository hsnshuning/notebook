主从模式
    AOF和RDB保证了崩溃后的数据恢复，尽量减少了数据丢失，但是在崩溃恢复的时候，redis是无法对外提供服务的，这时就需要在崩溃时，减少服务的中断时间，redis通过增加冗余副本，将一份数据存储在多个实例上，即使一个实例出现了问题， 还有其他实例对外提供服务，不会影响业务使用。
    主从库之间采用的是读写分离的方式，即主从库都可以进行读操作，写操作要在主库执行，主库将写操作再同步给从库
    主从全量复制的步骤
        主从库建立连接，协商同步，从库告诉主库即将进行同步，主库确认后即可开始同步
            从库发送psync命令给主库，psync包含主库的runId和复制进度offset两个参数，runId是每个redis实例启动时生成的一个随机ID，进行第一次复制时，因为不知道主库的runID所以设为'?'，offset设为-1，表示要进行全量复制
            主库收到psync命令，响应FULLRESYNC命令，并带上runID和offset。FULLRESYNC命令表示全量复制

        主库将所有数据通过RDB文件的形式同步给从库，从库收到数据后在本地完成数据加载。
            主库bgsave生成RDB
            发送RDB给从库
            从库接受RDB
            从库清空数据库
            从库加载RDB

        主库将生成RDB后发生的写操作同步给从库

    增量复制
        场景：主从库完成了全量复制后，主从库之间就会维护一个长连接，主库通过这个连接，把收到的命令同步给从库。但是当网络连接断开了，或者遇到网络阻塞了，主从库之间就会出现数据不一致了。
        解决方案：当发生连接断开，主从库会采用增量复制的方式继续同步，即把主从库网络连接断开的期间，主库收到的命令，同步给从库。
        原理
            replication buffer：主从库全量复制时的buffer
            repl_backlog_buffer：增量复制使用的buffer
            主库会维护一个replication buffer和一个repl_backlog_buffer(一个环形缓冲区，主库会记录写offset，从库会记录读offset)，当主从库断连后，主库会把断开断开期间的写请求缓存入replication buffer，同时也会写入repl_backlog_buffer。
            主从连接恢复后，从库给主库发送psync 带上读offset
            主库根据收到的读offset，计算要发送的数据

        问题：当主库写操作很多时，如果断连，主库会把repl_backlog_buffer写满，覆盖掉断连的从库还没有同步的数据，当从库再次连接同步数据时，就会发生主从数据不一致的问题了

    主从复制异常情况
        主从复制期间网络断连：当执行主从复制期间网络断连，会导致slave无法同步到master在此期间写入的数据，如果恰巧主库的写入请求很多，会导致新写入的数据将repl_backlog缓冲区中slave还没有同步的旧数据覆盖掉，当覆盖之后slave连接到master，发送自己需要的offset，master发现该offset已经被覆盖，就会触发全量复制。要防止此问题的发生，可以用repl_backlog_size参数适当调大repl_backlog的大小，更重要的时要保证网络质量
        写入量大导致断连：redis对于每个客户端会维护一个写入buffer，master写命令执行完成后会把该命令放入slave的写入buffer中，等待网络循环事件把buffer中的数据发送给slave，发送陈工后master会释放buffer中的内存。当master写入量很大，这时又出现了网络阻塞或者slave的压力较大出现瓶颈，无法及时处理master发送的请求，写入buffer就会积压，最该buffer满了，redis就会断开与slave的连接。解决该问题，首先可以适当调高buffer的大小，更重要的是找到根本问题，如果是网络问题，需要保证网络质量，如果是slave节点当时出现瓶颈，就要找到slave的瓶颈及发生这种情况的原因，根据原因最终解决该问题
        添加slave节点时阻塞：添加slave节点时，master收到同步请求，会fork一个子进程，在执行fork的时候master会阻塞，直到fork完成， fork会拷贝父进程的内存页表给子进程，如果master的内存使用的太大的话，这个操作的时间会变大，会导致master在这段时间内无法处理请求。对于该问题的优化，首先可以根据info命令中的latest_fork_usec的数据判断用时否在可接受的范围内，如果不在可接受的范围内，可以考虑多个redis实例，将数据打散，降低每个master的内存，从而提升fork操作的速度。

    问题：主从数据不一致，redis不保证主从数据强一致性

主从从模式
    主从模式中，当有多个从库需要和主库建立关系时，需要多个从库和主库完成复制，这时可能复制耗时比较长，fork对主库的压力，多从库传输RDB文件对主库带宽的压力等导致影响主库对外提供服务，主从从模式可以分担主库这方面的压力。
    主从从模式将主库生成RDB和传输RDB的压力分散到从库上

哨兵
    哨兵是一个运行在特殊模式下的redis进程
    哨兵的职责
        监控：哨兵周期性给主从库发送PING命令，检测是否仍在运行，如果从库没有在规定时间内响应哨兵，哨兵就会把它标记为下线，如果主库没有响应，哨兵就会判定主库下线，然后开始切换主库
        选主：当主库挂了，哨兵需要在从库中选择一个，作为新主库
        通知：选择新主库之后，哨兵把新主库的信息，发送给其他从库，从库执行replicaof命令和主库建立连接，同时哨兵会把新主库的连接信息通知给客户端，客户端把写请求发送给新的主库

    下线的判断
        从节点
            ping从库，超时会先标记为主观下线

        主节点

    新主库的选择
        哨兵在多个从库中筛选出符合条件的从库，再对从库打分，分数最高的从库作为新主库
        筛选条件
            当前从库正常运行
            从库之前的网络连接状态较好

        打分
            按照从库优先级打分， 从库优先级由slave-priority配置
            按照和主库同步的程度打分，根据master_repl_offset和slave_repl_offset计算
            按照优先级和同步程度打分如果出现最大分值有多个从库，在按照ID由小到大排序


    哨兵集群
        多个哨兵实例组成哨兵集群，解决单哨兵节点故障，导致无法对redis进行监控，选主等操作。
        原理：基于redis的pub/sub机制，订阅__sentinel__:hello频道，哨兵将自己的ip和端口发布带该频道，其他订阅了该频道的哨兵就可以获取到其他哨兵的ip信息
        主从库信息：通过info命令可以在主库获取主从库信息
        通知客户端：当主从库进行切换时，哨兵需要通知客户端新主库的地址，通过哨兵实例的pub/sub机制，客户端订阅哨兵实例提供的各个频道，以获取各个事件
            客户端如果想知道主从库切换的信息，那么订阅+switch-master频道即可

        哨兵leader
            作用：哨兵leader的职责是当发生主库宕机，进行主库选择，主从切换，通知从库和客户端
            leader的选择：当主库发生故障时，通过投票的方式进行选择
                哨兵发现主库故障，将主库标记为主观下线，并向其他哨兵发送is-master-down-by-addr确认主库是否是客观下线
                当收到半数以上的赞成时，将主库标记为客观下线，并发起选举自己为leader，给自己投一个选票
                当拿到了大于等于quorum数量的选票时，该哨兵成为leader
                如果一轮投票结束之后，没有选出新的leader，哨兵集群会等待一段时间（哨兵故障转移超时时间 * 2）再重新选举。

            是否存在哨兵节点同时发现主库主观下线，然后投票给自己，最终导致无法选出leader进行主从切换？
                可能，但概率较小
                不同哨兵的网络连接，系统压力不同
                检查主从库状态是时间事件，定时执行，每个哨兵在执行周期会加上随机数错开各个哨兵的时间。




脑裂
    描述：脑裂是指在主从集群中，同时有两个主节点，他们都能接收写请求，这就导致客户端的数据写到了两个主节点中，丢失数据
    成因：因为网络等原因，导致哨兵判定主库客观下线进行主从切换，但此时主库并没有下线，还在处理客户端请求，当新主库选出来以后，哨兵让旧主库作为从节点连接到新主库，旧主库就会清空库中的数据，然后写入新主库传来的RDB文件数据，在清空数据时，就会导致在进行主从切换期间，旧主库处理的数据丢失了。
    解决方案：和主库连接的从库至少有N个从库和主库进行数据复制的时候延迟时间小于T秒，否则不接收客户端请求。
        redis提供了两个配置项，min-slaves-to-write主库能进行数据同步的最少从库数量和min-slaves-max-lag主从库间进行数据复制时，从库给主库发送ACK消息的最大延迟


