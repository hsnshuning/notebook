# 哨兵模式
哨兵是一个特殊的redis进程，这个进程不是用来存数据的，而是用来通过监控主从库的状态来达到redis数据库节点自动故障转移的目的。

## 启动哨兵
1. `redis-sentinel /path/to/your/sentinel.conf`
2. `redis-server /path/to/your/sentinel.conf --sentinel`

## 哨兵的职责
1. 监控
    * 哨兵定期发送INFO命令和PING命令给主从库监控主从库的状态。从库如果超时的话，哨兵就会标记从库下线。主库如果超时的话，哨兵就会判定主库下线，进行重新选主。
2. 选主
    * 当主库不响应了，哨兵会在从库中选一个来当主库。
3. 通知
    * 新主库选出来之后，哨兵需要把新主库的信息同步给其他从库。同时也要把新主库的信息同步给客户端。

## 哨兵与主从的关系
哨兵会配置一个要监控的主库，通过给主库发送INFO命令哨兵可以知道其他从库的信息，哨兵会和每个库建立命令连接和订阅链接两个连接。一般情况下哨兵每10s向主从库发送INFO命令监控状态，当主库处于下线状态或者正在进行故障转移时时间缩短到1s。

## 哨兵集群
启动多个哨兵组成集群，哨兵集群中的每个哨兵，通过订阅主库的__sentinel__:hello频道来接收其他哨兵的信息，同时也会向主库的这个频道中发送自己的监控信息。与此同时，哨兵之间也会建立命令连接，用来交换信息。

## 主客观下线
对于哨兵的ping命令，主库在一段时间内连续返回非法响应，哨兵会将主库标记为主观下线，然后哨兵开始检测客观下线。检测客观下线的流程是向其他哨兵询问主库的状态，统计收到其他哨兵发来的主库下线的数量，达到配置的值时就标记主库客观下线。

## 哨兵选主
哨兵选主类似于raft协议，所有的哨兵节点都有资格成为leader，哨兵内部有一个计数器，相当于raft中的任期。当哨兵发现主库进入客观下线状态时，会通知其他哨兵选择自己做leader，给其他哨兵发送一个命令，命令中带着runid和任期号，其他哨兵选择leader的方式很简单就是先到先得，返回给候选人节点任期号和runid，候选人节点先看任期号，任期号和自己相同，说明是返回给自己的，然后继续看runid，runid如果也是自己的话就说明这个节点选了自己，然后累加自己的选票，当选票超过了半数n/2+1时该候选人节点当选，如果超时没有选出来的话就继续选举，直到选出一个leader出来。

## redis选主
哨兵在维护的redis列表中，删除已经标记下线或者断线的服务器，留下正常的服务器。继续删除表中最近5秒没有恢复哨兵info命令的从服务器，保证从库现在网路正常。再删除所有与主库断开连接超过一定时间的服务器，保证从库的数据比较新。剩下的根据优先级排序选出最高的那个，有多个优先级最高的，就选一个offset最高的，如果还有重复的，就按照runID来排序。当选出主库之后，哨兵给新主库发送`slave no one`命令，然后定时发送INFO命令，查看新主库是否切换完成。哨兵查看到主库切换完成之后通过给其他从库发送`slaveof`命令让其他从库复制新主库的数据。