# 分布式事务
分布式事务是用于在分布式系统中实现事务，由多个本地事务构成。

# 2PC
Two-phase commit protocol二阶段提交协议，二阶段指prepare和commit两阶段。2PC引入协调者参与本地事务的提交和回滚，尽量保证强一致性。
1. prepare阶段协调者给各个参与者发送准备命令。
2. 所有参与者都响应之后进入提交阶段。
所有的参与者都成功，发送提交命令，有事务失败了，发送回滚命令。第一阶段出现异常了直接回滚就好了，第二阶段出现异常的话就要不断重试了，不然会出现数据不一致的问题。

## 存在的问题
1. 参与者资源在占用的情况下，整个分布式事务被阻塞。
2. 事务执行的状态只有协调者和参与者自己知道，没有在系统内达成一致，当第二阶段执行的时候某个参与者和协调者都挂了，这种情况新协调者起来之后不知道该回滚还是该提交了。

其实上述2问题可以通过日志和互相询问的方式解决，但这也不算是一般的2PC了

# 3PC
3PC从2PC的prepare和commit阶段改为了CanCommit，PreCommit，DoCommit阶段。引入了PreCommit阶段统一了状态，进入PreCommit阶段的参与者可以推断出其他参与者也进入了PreCommit阶段，在等待DoCommit超时后可以自行提交事务，但并不能保证这个提交事务是正确的处理，因为协调者可能发送的是回滚命令，这时候其他参与者已经回滚了，但这个参与者因为网络原因没有收到，这就导致数据不一致了。
1. CanCommit阶段询问所有参与者资源占用情况等，不会锁资源。
2. 所有的参与者都回复ok，协调者发送PreCommit锁资源。
3. PreCommit阶段全部成功后，真正执行commit或rollback。

## 存在的问题
1. 引入了超时问题但也导致可能出现数据不一致的问题。

# TCC
2PC和3PC是无法解决业务层面的分布式事务的，因为业务层面可能用的数据库都不一样，也没法操作别人的数据库。所以出现了TCC，Try-Confirm-Cancel。
1. Try锁定资源。
2. Confirm执行。
3. Cancel取消。
和2PC查不多，Try锁定资源，Confirm进行执行或者Cancel进行回滚。

## 存在的问题
1. 首先需要外部服务提供Try，Confirm和Cancel，不太现实
2. 事务和业务的耦合性太强。
3. 可能会进行重试，confirm和cancel操作都需要保证幂等性。


# 本地消息表
各系统本地都维护一张本地消息表，通过本地事务来保证本地业务执行和本地消息的一致性，


# 消息队列事务
RocketMQ需要发送方实现反查事务执行是否成功的接口，进来的消息先丢队列，然后执行本地事务记录事务状态，对RocketMQ上报成功还是失败，同时RocketMQ也会查询这个事务的执行状态，如果是成功，就投递消息，如果是失败，就丢弃消息。

# 
