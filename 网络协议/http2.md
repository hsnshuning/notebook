# HTTP2
## 问题
1. 为什么http1.X会导致底层TCP效率低下？

## HTTP1.X的缺陷
1. 同一个连接上不支持并发。
2. 请求头和响应头开销大。
3. 不支持请求优先级，导致底层TCP连接的利用率低下。

## 特性简述
1. 通过完整的请求与响应复用来减少延迟。
2. 通过压缩协议头降低网络开销。
3. 增加请求优先级和服务器推送的支持。
4. 其他协议的辅助支持，如流控制，错误处理和升级机制。

HTTP2和HTTP1.1对比，具体修改了什么？

## HTTP2如何改进
核心的方法，状态码，URI和header字段都一样，引入了分帧层，修改了数据格式化以及传输方式。

### 分帧层
HTTP1.X的头采用纯文本格式，HTTP2将所有传输的信息分割成更小的消息和帧，采用二进制对他们进行编码。因为协议的变动，所以HTTP1.X的客户端是无法和HTTP2的服务器通信的。

#### 帧格式
 +-----------------------------------------------+

 |                 Length (24)                   |

 +---------------+---------------+---------------+

 |   Type (8)    |   Flags (8)   |

 +-+-------------+---------------+-------------------------------+

 |R|                 Stream Identifier (31)                      |

 +=+=============================================================+

 |                   Frame Payload (0...)                      ...

 +---------------------------------------------------------------+
 
* length：最大值为SETTINGS_MAX_FRAME_SIZE
* type：帧的类型和语义。
* flags：一些特殊标记。
* stream identifier：流标识符。如果不是独立的流而是与整个连接相关，流标识符为0。

### 请求与响应复用
通过分帧支持多个http消息交错发送，在另一端进行消息的重组，以达到一个连接同时双向发送多个请求或响应的目的。

### 数据流传输优先级
HTTP2通过标识数据流的权重和父数据流关系来实现数据流的资源分配优先级，根据数据流的父子关系可以构建出一颗数据流树，优先传输父数据流，同级数据流可以同时处理，根据权重比例来分配CPU等资源。
需要注意的是，**传输优先级并不代表处理优先级**，处理是不受依赖关系和权重控制的，这也是为了防止**父数据流阻塞的情况下，后面的子数据流都无法处理**的情况发生。

### 每个来源一个连接
通过分帧机制将一个请求分成1个或多个数据帧，以数据帧为单位进行传输，在另一段进行数据组装，那其实也就是可以在一个连接上进行并发，也就是一个连接我可以同时给多个线程用，这样就可以充分复用底层TCP协议通道，减少并发需要创建的连接数，减少资源的消耗。

### 流控制
流控制就是流量控制，和TCP的流量控制做的事情类似，通过通知另一方以完成提速，降速，暂停等功能。与TCP类似，但是TCP提供的是传输层的流量控制，HTTP2提供的是应用级的流量控制。

### 服务器推送


### 标头压缩
通过霍夫曼编码将头进行压缩，维护一个静态表和一个动态表。


1. 数据流：数据流指在一个建立的连接内进行双向传输。可以同时发送一条或多条消息。
2. 消息：对应着一条完整的请求或响应。
3. 帧：通信的最小单位，将请求和响应拆分为帧，每个帧包含帧头，有一系列该帧的信息。

## HTTP2帧的一些类型
1. magic帧。建立连接一方发送这个帧，相当于做一个确认版本之类的工作。
2. settings帧。发送magic帧后双方会各自发送settings帧，设置整个连接的一些参数，如窗口大小之类的。
3. window_update帧。用于通知对方，将窗口设置为不同大小，以达到流控制的目的。
4. ping/pong帧。探活，计算往返时间。


